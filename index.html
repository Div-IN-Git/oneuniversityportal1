<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>UUP â€” University Unified Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --green:#248657;
  --green-light:#2fa36a;
  --green-pale:#e8f5ee;
  --green-dim:#1a5e3d;
  --white:#ffffff;
  --off-white:#f7faf8;
  --gray-50:#f4f6f5;
  --gray-100:#e8edea;
  --gray-200:#d1dbd5;
  --gray-400:#8fa89a;
  --gray-600:#4a635a;
  --gray-800:#1e2e28;
  --text:#1a2822;
  --text-muted:#5a7068;
  --danger:#e53e3e;
  --warning:#d97706;
  --info:#2b7cb8;
  --radius:12px;
  --radius-lg:20px;
  --shadow:0 2px 16px rgba(36,134,87,0.08);
  --shadow-lg:0 8px 40px rgba(36,134,87,0.14);
}
html,body{height:100%;font-family:'Sora',sans-serif;background:var(--off-white);color:var(--text);font-size:14px;line-height:1.6}
button{cursor:pointer;font-family:'Sora',sans-serif}
input,textarea,select{font-family:'Sora',sans-serif}

/* â”€â”€ UTILITIES â”€â”€ */
.hidden{display:none!important}
.flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:4px}.gap-2{gap:8px}.gap-3{gap:12px}.gap-4{gap:16px}
.text-xs{font-size:11px}.text-sm{font-size:12px}.text-base{font-size:14px}.text-lg{font-size:16px}.text-xl{font-size:20px}.text-2xl{font-size:24px}
.fw-400{font-weight:400}.fw-500{font-weight:500}.fw-600{font-weight:600}.fw-700{font-weight:700}
.text-green{color:var(--green)}.text-muted{color:var(--text-muted)}.text-danger{color:var(--danger)}.text-warning{color:var(--warning)}
.w-full{width:100%}.mt-1{margin-top:4px}.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}.mt-6{margin-top:24px}
.p-2{padding:8px}.p-3{padding:12px}.p-4{padding:16px}.p-5{padding:20px}
.rounded{border-radius:var(--radius)}.rounded-full{border-radius:999px}
.bg-white{background:#fff}.bg-green{background:var(--green)}.bg-pale{background:var(--green-pale)}
.shadow{box-shadow:var(--shadow)}.shadow-lg{box-shadow:var(--shadow-lg)}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 10px;border-radius:999px;font-size:11px;font-weight:600}
.badge-green{background:var(--green-pale);color:var(--green-dim)}
.badge-red{background:#fee2e2;color:#b91c1c}
.badge-orange{background:#fef3c7;color:#92400e}
.badge-blue{background:#dbeafe;color:#1e40af}
.divider{height:1px;background:var(--gray-100);margin:12px 0}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--gray-200);border-radius:3px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 18px;border-radius:var(--radius);border:none;font-size:13px;font-weight:600;transition:all .15s}
.btn-primary{background:var(--green);color:#fff}.btn-primary:hover{background:var(--green-light)}
.btn-ghost{background:transparent;color:var(--green);border:1.5px solid var(--green)}.btn-ghost:hover{background:var(--green-pale)}
.btn-danger{background:#fee2e2;color:#b91c1c;border:none}.btn-danger:hover{background:#fecaca}
.btn-sm{padding:5px 12px;font-size:11px;border-radius:8px}
.btn-icon{padding:6px;border-radius:8px;background:var(--gray-50);border:1px solid var(--gray-100);color:var(--gray-600)}.btn-icon:hover{background:var(--gray-100)}

/* â”€â”€ INPUTS â”€â”€ */
.input{width:100%;padding:10px 14px;border:1.5px solid var(--gray-200);border-radius:var(--radius);font-size:13px;background:#fff;transition:border .15s;outline:none}
.input:focus{border-color:var(--green)}
.label{display:block;font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.form-group{margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#page-login{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#f0f9f4 0%,#e8f5ee 50%,#d1f0e0 100%);position:relative;overflow:hidden}
#page-login::before{content:'';position:absolute;top:-60px;right:-60px;width:300px;height:300px;background:radial-gradient(circle,rgba(36,134,87,.12) 0%,transparent 70%);border-radius:50%}
#page-login::after{content:'';position:absolute;bottom:-80px;left:-40px;width:250px;height:250px;background:radial-gradient(circle,rgba(36,134,87,.08) 0%,transparent 70%);border-radius:50%}
.login-card{background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(36,134,87,.15);padding:48px 40px;width:100%;max-width:440px;position:relative;z-index:1;animation:fadeUp .4s ease}
.login-logo{font-family:'DM Serif Display',serif;font-size:28px;color:var(--green);letter-spacing:-0.5px;margin-bottom:4px}
.login-tagline{font-size:12px;color:var(--text-muted);margin-bottom:32px}
.role-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px}
.role-btn{padding:16px 8px;border-radius:14px;border:2px solid var(--gray-100);background:var(--gray-50);text-align:center;transition:all .2s;cursor:pointer}
.role-btn.active{border-color:var(--green);background:var(--green-pale)}
.role-btn .role-icon{font-size:24px;margin-bottom:6px}
.role-btn .role-label{font-size:11px;font-weight:600;color:var(--text-muted)}
.role-btn.active .role-label{color:var(--green)}
.login-divider{text-align:center;color:var(--gray-400);font-size:11px;margin:16px 0;position:relative}
.login-divider::before,.login-divider::after{content:'';position:absolute;top:50%;width:42%;height:1px;background:var(--gray-100)}
.login-divider::before{left:0}.login-divider::after{right:0}
.google-btn{width:100%;padding:11px;border:1.5px solid var(--gray-200);border-radius:var(--radius);background:#fff;display:flex;align-items:center;justify-content:center;gap:10px;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s}.google-btn:hover{border-color:var(--green);background:var(--green-pale)}
.google-icon{width:18px;height:18px;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23EA4335' d='M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z'/%3E%3Cpath fill='%234285F4' d='M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z'/%3E%3Cpath fill='%23FBBC05' d='M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z'/%3E%3Cpath fill='%2334A853' d='M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.36-8.16 2.36-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z'/%3E%3C/svg%3E") center/contain no-repeat;flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;height:100vh;overflow:hidden}
.sidebar{width:230px;flex-shrink:0;background:#fff;border-right:1px solid var(--gray-100);display:flex;flex-direction:column;height:100vh;overflow-y:auto}
.sidebar-header{padding:20px 16px 12px;border-bottom:1px solid var(--gray-100)}
.sidebar-logo{font-family:'DM Serif Display',serif;font-size:18px;color:var(--green);letter-spacing:-.3px}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:12px 16px;margin:8px;border-radius:var(--radius);background:var(--green-pale)}
.sidebar-user-avatar{width:36px;height:36px;border-radius:50%;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0}
.sidebar-user-name{font-size:12px;font-weight:600;color:var(--green-dim);line-height:1.2}
.sidebar-user-role{font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:.5px}
.sidebar-nav{padding:8px;flex:1}
.nav-section{margin-bottom:8px}
.nav-section-label{font-size:10px;font-weight:700;color:var(--gray-400);text-transform:uppercase;letter-spacing:.8px;padding:8px 8px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:500;color:var(--gray-600);transition:all .15s;position:relative}
.nav-item:hover{background:var(--gray-50);color:var(--text)}
.nav-item.active{background:var(--green-pale);color:var(--green);font-weight:600}
.nav-item .nav-icon{font-size:16px;width:20px;text-align:center}
.nav-badge{margin-left:auto;background:var(--green);color:#fff;border-radius:999px;font-size:10px;padding:1px 7px;font-weight:700}
.sidebar-footer{padding:12px;border-top:1px solid var(--gray-100)}

.main-area{flex:1;overflow-y:auto;background:var(--off-white)}
.topbar{background:#fff;border-bottom:1px solid var(--gray-100);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-title{font-size:16px;font-weight:700;color:var(--text)}
.topbar-search{display:flex;align-items:center;gap:8px;background:var(--gray-50);border:1.5px solid var(--gray-100);border-radius:999px;padding:6px 14px;width:280px;transition:all .15s}
.topbar-search:focus-within{border-color:var(--green);background:#fff}
.topbar-search input{border:none;background:transparent;outline:none;font-size:13px;width:100%;color:var(--text)}
.content{padding:24px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS & COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow);border:1px solid var(--gray-100)}
.card-header{padding:16px 20px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between}
.card-body{padding:20px}
.card-title{font-size:14px;font-weight:700;color:var(--text)}

.stat-card{padding:20px;border-radius:var(--radius-lg);border:1px solid var(--gray-100);background:#fff;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.07}
.stat-card.green::before{background:var(--green)}
.stat-card.orange::before{background:var(--warning)}
.stat-card.blue::before{background:var(--info)}
.stat-value{font-size:28px;font-weight:700;font-family:'DM Serif Display',serif;line-height:1}
.stat-label{font-size:11px;color:var(--text-muted);font-weight:500;margin-top:4px}

.profile-hero{background:linear-gradient(135deg,var(--green) 0%,var(--green-light) 100%);border-radius:var(--radius-lg);padding:28px;color:#fff;position:relative;overflow:hidden;margin-bottom:20px}
.profile-hero::after{content:'';position:absolute;right:-30px;top:-30px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.08)}
.profile-avatar{width:70px;height:70px;border-radius:50%;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;margin-bottom:12px;border:3px solid rgba(255,255,255,.4);overflow:hidden}
.profile-avatar img{width:100%;height:100%;object-fit:cover}

.announcement-item{padding:14px 16px;border-radius:var(--radius);border:1px solid var(--gray-100);background:#fff;margin-bottom:8px;transition:box-shadow .15s}
.announcement-item:hover{box-shadow:var(--shadow)}
.ann-type-badge{font-size:10px;padding:2px 8px;border-radius:999px;font-weight:700;margin-bottom:6px;display:inline-block}

.file-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--radius);border:1px solid var(--gray-100);background:#fff;margin-bottom:8px;transition:all .15s}
.file-item:hover{border-color:var(--green);background:var(--green-pale)}
.file-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.file-icon.pdf{background:#fee2e2}
.file-icon.img{background:#dbeafe}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn .15s}
.modal{background:#fff;border-radius:var(--radius-lg);width:100%;max-width:520px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:slideUp .2s ease}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:1}
.modal-body{padding:24px}
.modal-close{width:28px;height:28px;border-radius:6px;background:var(--gray-50);border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;color:var(--gray-600)}
.modal-close:hover{background:var(--gray-100)}

.attendance-bar{height:10px;background:var(--gray-100);border-radius:999px;overflow:hidden;margin-top:6px}
.attendance-fill{height:100%;border-radius:999px;transition:width .5s ease}

.search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--gray-200);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:200;max-height:300px;overflow-y:auto;margin-top:4px}
.search-result-item{padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:background .1s}
.search-result-item:hover{background:var(--green-pale)}

.toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:#fff;padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:500;z-index:9999;animation:slideRight .3s ease;box-shadow:var(--shadow-lg)}
.toast.error{background:var(--danger)}

.tabs{display:flex;gap:4px;background:var(--gray-50);padding:4px;border-radius:10px;margin-bottom:20px}
.tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;color:var(--text-muted);transition:all .15s;border:none;background:transparent}
.tab.active{background:#fff;color:var(--green);box-shadow:0 1px 4px rgba(0,0,0,.08)}

.empty-state{text-align:center;padding:48px 24px;color:var(--text-muted)}
.empty-state .empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}

/* toggle */
.toggle{position:relative;display:inline-block;width:40px;height:22px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;inset:0;background:var(--gray-200);border-radius:999px;cursor:pointer;transition:.2s}
.toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked+.toggle-slider{background:var(--green)}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px)}

@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideRight{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-login">
  <div class="login-card">
    <div class="login-logo">ğŸ“ UUP</div>
    <div class="login-tagline">University Unified Portal â€” Your campus, connected.</div>
    
    <div class="form-group">
      <label class="label">Sign in as</label>
      <div class="role-grid">
        <div class="role-btn active" data-role="student" onclick="selectRole('student',this)">
          <div class="role-icon">ğŸ‘¨â€ğŸ“</div>
          <div class="role-label">Student</div>
        </div>
        <div class="role-btn" data-role="professor" onclick="selectRole('professor',this)">
          <div class="role-icon">ğŸ‘¨â€ğŸ«</div>
          <div class="role-label">Professor</div>
        </div>
        <div class="role-btn" data-role="admin" onclick="selectRole('admin',this)">
          <div class="role-icon">ğŸ›</div>
          <div class="role-label">Admin</div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="label">University ID</label>
      <input class="input" id="login-id" placeholder="e.g. STU2024001 / PROF001 / ADM001" value="STU2024001"/>
    </div>
    <div class="form-group">
      <label class="label">Password</label>
      <input class="input" id="login-pass" type="password" placeholder="Enter your password" value="password123"/>
    </div>
    <button class="btn btn-primary w-full" style="margin-bottom:12px" onclick="login()">Sign In â†’</button>
    
    <div class="login-divider">or continue with</div>
    <button class="google-btn" onclick="googleLogin()">
      <span class="google-icon"></span> Sign in with Google (University Account)
    </button>
    
    <p style="text-align:center;color:var(--gray-400);font-size:11px;margin-top:16px">Demo: any ID/password works. Role determines dashboard.</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="flex">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">ğŸ“ UUP</div>
    </div>
    <div class="sidebar-user">
      <div class="sidebar-user-avatar" id="sb-avatar">S</div>
      <div>
        <div class="sidebar-user-name" id="sb-name">Loading...</div>
        <div class="sidebar-user-role" id="sb-role">Role</div>
      </div>
    </div>
    <nav class="sidebar-nav" id="sidebar-nav"></nav>
    <div class="sidebar-footer">
      <button class="btn btn-ghost w-full btn-sm" onclick="logout()">â¬… Sign Out</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="flex-col" style="flex:1;min-width:0">
    <div class="topbar">
      <div class="topbar-title" id="topbar-title">Dashboard</div>
      <div style="display:flex;align-items:center;gap:12px">
        <div class="topbar-search" id="global-search-wrap" style="position:relative">
          <span style="font-size:14px;color:var(--gray-400)">ğŸ”</span>
          <input id="global-search" placeholder="Search professors & admins..." autocomplete="off" oninput="globalSearch(this.value)"/>
          <div class="search-results hidden" id="search-results"></div>
        </div>
      </div>
    </div>
    <div class="main-area">
      <div class="content" id="main-content"></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="closeModalOverlay(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <span class="fw-700" id="modal-title">Modal</span>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast hidden" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE (localStorage-backed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB = {
  get(k){try{return JSON.parse(localStorage.getItem('uup_'+k))||null}catch{return null}},
  set(k,v){localStorage.setItem('uup_'+k,JSON.stringify(v))},
  del(k){localStorage.removeItem('uup_'+k)}
};

// Seed default data
function initDB(){
  if(!DB.get('seeded')){
    DB.set('users', [
      {id:'PROF001',name:'Dr. Priya Sharma',role:'professor',dept:'Computer Science',designation:'Associate Professor',bio:'10+ years in ML and AI research. Published 20+ papers.',email:'priya.sharma@university.edu',phone:'9876543210',image:'',following:false,timetableVisible:true},
      {id:'PROF002',name:'Dr. Arjun Mehta',role:'professor',dept:'Mathematics',designation:'Professor',bio:'Algebraist with a love for abstract math. HOD of Math dept.',email:'arjun.mehta@university.edu',phone:'9876543211',image:'',following:false,timetableVisible:true},
      {id:'ADM001',name:'Ms. Kavita Rao',role:'admin',dept:'Administration',designation:'Dean â€” Academic Affairs',bio:'Overseeing curriculum, admissions, and faculty welfare.',email:'kavita.rao@university.edu',phone:'9876543212',image:'',following:false,timetableVisible:false},
    ]);
    DB.set('notes', [
      {id:'n1',uploaderId:'PROF001',name:'Data Structures â€” Unit 3.pdf',type:'pdf',date:'2025-01-10',subject:'DSA'},
      {id:'n2',uploaderId:'PROF001',name:'Machine Learning Basics.pdf',type:'pdf',date:'2025-01-15',subject:'ML'},
      {id:'n3',uploaderId:'PROF002',name:'Linear Algebra Notes.pdf',type:'pdf',date:'2025-01-08',subject:'Math'},
    ]);
    DB.set('qpapers', [
      {id:'q1',uploaderId:'PROF001',name:'DSA End-Sem 2024.pdf',year:'2024',subject:'DSA',important:['Q2: Explain AVL Trees','Q5: Write BFS/DFS algorithms']},
      {id:'q2',uploaderId:'PROF002',name:'Math Mid-Term 2024.pdf',year:'2024',subject:'Math',important:['Q1: Eigen values','Q3: Matrix decomposition']},
    ]);
    DB.set('announcements', [
      {id:'a1',by:'PROF001',byName:'Dr. Priya Sharma',role:'professor',type:'class',text:'Assignment 3 deadline extended to Jan 30. Please submit on portal.',date:'2025-01-18',dept:'CS'},
      {id:'a2',by:'ADM001',byName:'Ms. Kavita Rao',role:'admin',type:'university',text:'ğŸ‰ Annual Tech Fest "InnoVate 2025" â€” Feb 5â€“7. Registrations open!',date:'2025-01-20',dept:'All'},
      {id:'a3',by:'PROF002',byName:'Dr. Arjun Mehta',role:'professor',type:'class',text:'Extra class on Saturday 10am â€” Room 204.',date:'2025-01-19',dept:'Math'},
    ]);
    DB.set('timetables', [
      {id:'tt1',uploaderId:'PROF001',name:'CS Dept Timetable Spring 2025',type:'dept',url:'#'},
      {id:'tt2',uploaderId:'ADM001',name:'Official University Master Timetable',type:'master',url:'#'},
    ]);
    DB.set('attendance', {
      // keyed by studentId
      'STU2024001': {total:60,present:42,subjects:{'DSA':{total:20,present:16},'ML':{total:20,present:14},'Math':{total:20,present:12}}}
    });
    DB.set('masterAttendance', []);
    DB.set('following', {});
    DB.set('seeded', true);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;

function selectRole(role, el){
  document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const hints = {student:'STU2024001', professor:'PROF001', admin:'ADM001'};
  document.getElementById('login-id').value = hints[role]||'';
}

function login(){
  const id = document.getElementById('login-id').value.trim();
  const role = document.querySelector('.role-btn.active').dataset.role;
  if(!id){showToast('Enter your University ID','error');return}

  let name = id;
  if(role==='professor'||role==='admin'){
    const users = DB.get('users')||[];
    const u = users.find(u=>u.id===id);
    if(u) name = u.name; else {showToast('ID not found. Using default.'); }
  } else {
    name = 'Student ('+id+')';
  }

  currentUser = {id, role, name};
  localStorage.setItem('uup_session', JSON.stringify(currentUser));
  bootApp();
}

function googleLogin(){
  const role = document.querySelector('.role-btn.active').dataset.role;
  const hint = {student:'STU2024001',professor:'PROF001',admin:'ADM001'};
  currentUser = {id:hint[role],role,name: role==='student'?'Student ('+hint[role]+')': (DB.get('users')||[]).find(u=>u.id===hint[role])?.name||hint[role]};
  localStorage.setItem('uup_session', JSON.stringify(currentUser));
  bootApp();
}

function logout(){
  currentUser=null;
  localStorage.removeItem('uup_session');
  document.getElementById('app').style.display='none';
  document.getElementById('page-login').style.display='flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bootApp(){
  initDB();
  document.getElementById('page-login').style.display='none';
  document.getElementById('app').style.display='flex';

  document.getElementById('sb-avatar').textContent = currentUser.name[0].toUpperCase();
  document.getElementById('sb-name').textContent = currentUser.name;
  document.getElementById('sb-role').textContent = currentUser.role.charAt(0).toUpperCase()+currentUser.role.slice(1);

  buildSidebar();
  navigate('home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION & SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NAV = {
  student: [
    {id:'home', icon:'ğŸ ', label:'Home'},
    {id:'announcements', icon:'ğŸ“¢', label:'Announcements', badge:()=>{ const ann=DB.get('announcements')||[]; return ann.length }},
    {id:'notes', icon:'ğŸ“‚', label:'Notes & Materials'},
    {id:'qpapers', icon:'ğŸ“„', label:'Question Papers'},
    {id:'attendance', icon:'âœ…', label:'Attendance'},
    {id:'timetable', icon:'ğŸ“…', label:'Timetables'},
    {id:'directory', icon:'ğŸ‘¥', label:'Faculty Directory'},
  ],
  professor: [
    {id:'home', icon:'ğŸ ', label:'Dashboard'},
    {id:'profile', icon:'ğŸ‘¤', label:'My Profile'},
    {id:'manage-notes', icon:'ğŸ“‚', label:'Upload Notes'},
    {id:'manage-qpapers', icon:'ğŸ“„', label:'Question Papers'},
    {id:'announcements-manage', icon:'ğŸ“¢', label:'Announcements'},
    {id:'timetable', icon:'ğŸ“…', label:'Timetables'},
  ],
  admin: [
    {id:'home', icon:'ğŸ ', label:'Dashboard'},
    {id:'profile', icon:'ğŸ‘¤', label:'My Profile'},
    {id:'manage-notes', icon:'ğŸ“‚', label:'Upload Notes'},
    {id:'manage-qpapers', icon:'ğŸ“„', label:'Question Papers'},
    {id:'announcements-manage', icon:'ğŸ“¢', label:'Announcements'},
    {id:'timetable', icon:'ğŸ“…', label:'Timetables'},
    {id:'master-attendance', icon:'ğŸ“Š', label:'Master Attendance'},
    {id:'directory', icon:'ğŸ‘¥', label:'Faculty Directory'},
  ]
};

function buildSidebar(){
  const nav = NAV[currentUser.role]||[];
  const container = document.getElementById('sidebar-nav');
  container.innerHTML = '<div class="nav-section-label">Menu</div>';
  nav.forEach(item=>{
    const badge = item.badge ? item.badge() : 0;
    const div = document.createElement('div');
    div.className = 'nav-item';
    div.id = 'nav-'+item.id;
    div.innerHTML = `<span class="nav-icon">${item.icon}</span><span>${item.label}</span>${badge?`<span class="nav-badge">${badge}</span>`:''}`;
    div.onclick = ()=>navigate(item.id);
    container.appendChild(div);
  });
}

let currentPage = '';
function navigate(page){
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el = document.getElementById('nav-'+page);
  if(el) el.classList.add('active');

  const titles = {
    home:'Dashboard', announcements:'Announcements', notes:'Notes & Study Materials',
    qpapers:'Question Papers', attendance:'Attendance Tracker', timetable:'Timetables',
    directory:'Faculty Directory', profile:'My Profile', 'manage-notes':'Upload & Manage Notes',
    'manage-qpapers':'Question Papers', 'announcements-manage':'Manage Announcements',
    'master-attendance':'Master Attendance'
  };
  document.getElementById('topbar-title').textContent = titles[page]||page;

  const renders = {
    home: renderHome,
    announcements: renderAnnouncements,
    notes: renderNotes,
    qpapers: renderQPapers,
    attendance: renderAttendance,
    timetable: renderTimetable,
    directory: renderDirectory,
    profile: renderProfile,
    'manage-notes': renderManageNotes,
    'manage-qpapers': renderManageQPapers,
    'announcements-manage': renderManageAnnouncements,
    'master-attendance': renderMasterAttendance
  };
  const fn = renders[page];
  if(fn) fn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  const role = currentUser.role;
  if(role==='student') renderStudentHome();
  else renderFacultyHome();
}

function renderStudentHome(){
  const att = getMyAttendance();
  const pct = att.total ? Math.round((att.present/att.total)*100) : 0;
  const annCount = (DB.get('announcements')||[]).length;
  const warn = pct < 75;

  let html = `
  ${warn?`<div style="background:#fef3c7;border:1.5px solid #fbbf24;border-radius:var(--radius);padding:12px 16px;margin-bottom:20px;display:flex;gap:10px;align-items:center">
    <span style="font-size:20px">âš ï¸</span>
    <div><strong>Attendance Warning!</strong><br><span style="font-size:12px;color:#92400e">Your attendance is ${pct}%, which is below the 75% requirement. Please attend classes regularly.</span></div>
  </div>`:''}

  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
    <div class="stat-card green">
      <div class="stat-value ${warn?'text-danger':''}">${pct}%</div>
      <div class="stat-label">Overall Attendance</div>
      <div class="attendance-bar"><div class="attendance-fill" style="width:${pct}%;background:${pct<75?'var(--danger)':pct<85?'var(--warning)':'var(--green)'}"></div></div>
    </div>
    <div class="stat-card blue">
      <div class="stat-value">${annCount}</div>
      <div class="stat-label">New Announcements</div>
    </div>
    <div class="stat-card orange">
      <div class="stat-value">${(DB.get('notes')||[]).length}</div>
      <div class="stat-label">Notes Available</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div class="card-header"><span class="card-title">ğŸ“¢ Recent Announcements</span> <button class="btn btn-ghost btn-sm" onclick="navigate('announcements')">View All</button></div>
      <div class="card-body" style="padding:12px">
        ${(DB.get('announcements')||[]).slice(0,3).map(a=>`
          <div class="announcement-item">
            <div><span class="ann-type-badge ${a.type==='university'?'badge-red':'badge-blue'}">${a.type==='university'?'ğŸ› University':'ğŸ“š Class'}</span></div>
            <div style="font-size:13px;font-weight:500">${a.text}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:4px">â€” ${a.byName} Â· ${a.date}</div>
          </div>`).join('')}
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">ğŸ“Š Subject-wise Attendance</span></div>
      <div class="card-body" style="padding:12px">
        ${Object.entries(att.subjects||{}).map(([sub,d])=>{
          const sp = d.total?Math.round(d.present/d.total*100):0;
          return `<div style="margin-bottom:12px">
            <div class="flex justify-between" style="font-size:12px"><span class="fw-600">${sub}</span><span class="${sp<75?'text-danger':'text-green'}">${sp}%</span></div>
            <div class="attendance-bar"><div class="attendance-fill" style="width:${sp}%;background:${sp<75?'var(--danger)':sp<85?'var(--warning)':'var(--green)'}"></div></div>
            <div style="font-size:10px;color:var(--text-muted)">${d.present}/${d.total} classes</div>
          </div>`;
        }).join('')}
      </div>
    </div>
  </div>`;
  document.getElementById('main-content').innerHTML = html;
}

function renderFacultyHome(){
  const users = DB.get('users')||[];
  const me = users.find(u=>u.id===currentUser.id)||{name:currentUser.name};
  const notes = (DB.get('notes')||[]).filter(n=>n.uploaderId===currentUser.id);
  const anns = (DB.get('announcements')||[]).filter(a=>a.by===currentUser.id);
  
  document.getElementById('main-content').innerHTML = `
  <div class="profile-hero">
    <div class="profile-avatar">${me.image?`<img src="${me.image}"/>`:(me.name||'?')[0]}</div>
    <div style="font-size:20px;font-weight:700;font-family:'DM Serif Display',serif">${me.name||currentUser.name}</div>
    <div style="opacity:.8;font-size:13px">${me.designation||''} ${me.dept?'Â· '+me.dept:''}</div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn btn-sm" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)" onclick="navigate('profile')">âœï¸ Edit Profile</button>
      <button class="btn btn-sm" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)" onclick="navigate('announcements-manage')">ğŸ“¢ Post Announcement</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
    <div class="stat-card green"><div class="stat-value">${notes.length}</div><div class="stat-label">Notes Uploaded</div></div>
    <div class="stat-card blue"><div class="stat-value">${anns.length}</div><div class="stat-label">Announcements</div></div>
    <div class="stat-card orange"><div class="stat-value">${(DB.get('qpapers')||[]).filter(q=>q.uploaderId===currentUser.id).length}</div><div class="stat-label">Question Papers</div></div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: ANNOUNCEMENTS (Student)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnnouncements(){
  const anns = DB.get('announcements')||[];
  let html = `<div class="tabs">
    <button class="tab active" onclick="filterAnn('all',this)">All</button>
    <button class="tab" onclick="filterAnn('university',this)">University</button>
    <button class="tab" onclick="filterAnn('class',this)">Class</button>
  </div>
  <div id="ann-list">`;
  anns.slice().reverse().forEach(a=>{
    html+=`<div class="announcement-item">
      <div class="flex justify-between items-center">
        <span class="ann-type-badge ${a.type==='university'?'badge-red':'badge-blue'}">${a.type==='university'?'ğŸ› University':'ğŸ“š Class'}</span>
        <span style="font-size:11px;color:var(--text-muted)">${a.date}</span>
      </div>
      <div style="font-size:14px;font-weight:500;margin-top:6px">${a.text}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:6px">â€” ${a.byName} Â· ${a.dept}</div>
    </div>`;
  });
  html += `</div>`;
  document.getElementById('main-content').innerHTML = html;
}
function filterAnn(type, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const anns = DB.get('announcements')||[];
  const filtered = type==='all'?anns:anns.filter(a=>a.type===type);
  const list = document.getElementById('ann-list');
  list.innerHTML = filtered.slice().reverse().map(a=>`
    <div class="announcement-item">
      <div class="flex justify-between items-center">
        <span class="ann-type-badge ${a.type==='university'?'badge-red':'badge-blue'}">${a.type==='university'?'ğŸ› University':'ğŸ“š Class'}</span>
        <span style="font-size:11px;color:var(--text-muted)">${a.date}</span>
      </div>
      <div style="font-size:14px;font-weight:500;margin-top:6px">${a.text}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:6px">â€” ${a.byName} Â· ${a.dept}</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes(){
  const notes = DB.get('notes')||[];
  const subjects = [...new Set(notes.map(n=>n.subject))];
  let html = `<div class="tabs">
    <button class="tab active" onclick="filterNotes('all',this)">All</button>
    ${subjects.map(s=>`<button class="tab" onclick="filterNotes('${s}',this)">${s}</button>`).join('')}
  </div>
  <div id="notes-list">`;
  notes.forEach(n=>{
    const uploader = (DB.get('users')||[]).find(u=>u.id===n.uploaderId);
    html+=fileItem(n, uploader?.name||n.uploaderId);
  });
  html+=`</div>`;
  document.getElementById('main-content').innerHTML = html;
}
function filterNotes(subj, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const notes = (DB.get('notes')||[]).filter(n=>subj==='all'||n.subject===subj);
  document.getElementById('notes-list').innerHTML = notes.map(n=>{
    const u=(DB.get('users')||[]).find(u=>u.id===n.uploaderId);
    return fileItem(n,u?.name||n.uploaderId);
  }).join('');
}
function fileItem(n, uploaderName){
  return `<div class="file-item">
    <div class="file-icon pdf">ğŸ“„</div>
    <div style="flex:1;min-width:0">
      <div class="fw-600 truncate">${n.name}</div>
      <div style="font-size:11px;color:var(--text-muted)">Uploaded by ${uploaderName} Â· ${n.date}</div>
    </div>
    <span class="badge badge-green">${n.subject||''}</span>
    <button class="btn btn-ghost btn-sm" onclick="fakeDownload('${n.name}')">â¬‡ Download</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: QUESTION PAPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQPapers(){
  const qps = DB.get('qpapers')||[];
  let html = `<div style="margin-bottom:16px;font-size:13px;color:var(--text-muted)">Access past exam papers. Important questions are highlighted by professors.</div>`;
  qps.forEach(q=>{
    const u=(DB.get('users')||[]).find(u=>u.id===q.uploaderId);
    html+=`<div class="card" style="margin-bottom:16px">
      <div class="card-header">
        <div>
          <div class="card-title">ğŸ“„ ${q.name}</div>
          <div style="font-size:11px;color:var(--text-muted)">Year: ${q.year} Â· Subject: ${q.subject} Â· ${u?.name||q.uploaderId}</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="fakeDownload('${q.name}')">â¬‡ Download</button>
      </div>
      ${q.important&&q.important.length?`<div class="card-body" style="padding:12px 20px">
        <div style="font-size:11px;font-weight:700;color:var(--warning);margin-bottom:8px">â­ IMPORTANT QUESTIONS</div>
        ${q.important.map(iq=>`<div style="padding:8px 12px;background:#fef3c7;border-radius:8px;margin-bottom:6px;font-size:13px">ğŸ“Œ ${iq}</div>`).join('')}
      </div>`:''}
    </div>`;
  });
  document.getElementById('main-content').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: ATTENDANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAttendance(){
  const att = getMyAttendance();
  const pct = att.total ? Math.round(att.present/att.total*100):0;
  const needed = att.total ? Math.max(0,Math.ceil(0.75*att.total - att.present)):0;
  const color = pct<75?'var(--danger)':pct<85?'var(--warning)':'var(--green)';
  
  let html = `
  <div class="card" style="margin-bottom:20px">
    <div class="card-body">
      <div style="display:flex;align-items:center;gap:24px">
        <div style="width:90px;height:90px;border-radius:50%;background:conic-gradient(${color} ${pct}%,var(--gray-100) 0);display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <div style="width:70px;height:70px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:${color}">${pct}%</div>
        </div>
        <div style="flex:1">
          <div style="font-size:18px;font-weight:700">Overall: ${att.present} / ${att.total} classes</div>
          <div style="font-size:13px;color:var(--text-muted);margin-top:4px">${pct>=75?`âœ… You meet the 75% requirement. You can miss ${Math.floor((att.present - 0.75*att.total)/0.25)} more classes.`:`âš ï¸ You need to attend ${needed} more class${needed>1?'es':''} to reach 75%.`}</div>
          <button class="btn btn-primary btn-sm mt-3" onclick="markAttendance()">Mark Today's Attendance</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-bottom:20px">
    <div class="card-header"><span class="card-title">ğŸ“Š Subject-wise Breakdown</span></div>
    <div class="card-body" style="padding:12px 20px">
      ${Object.entries(att.subjects||{}).map(([sub,d])=>{
        const sp=d.total?Math.round(d.present/d.total*100):0;
        const sc=sp<75?'var(--danger)':sp<85?'var(--warning)':'var(--green)';
        return `<div style="margin-bottom:16px">
          <div class="flex justify-between" style="margin-bottom:4px">
            <span class="fw-600">${sub}</span>
            <span style="font-weight:700;color:${sc}">${sp}% (${d.present}/${d.total})</span>
          </div>
          <div class="attendance-bar" style="height:12px"><div class="attendance-fill" style="width:${sp}%;background:${sc}"></div></div>
        </div>`;
      }).join('')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">ğŸ“… Upload Your Personal Timetable</span></div>
    <div class="card-body">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Upload your personal timetable (PDF or image) for reference.</p>
      <label style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:2px dashed var(--gray-200);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--text-muted);transition:all .15s" onmouseover="this.style.borderColor='var(--green)'" onmouseout="this.style.borderColor='var(--gray-200)'">
        ğŸ“ Click to upload timetable <input type="file" accept=".pdf,.jpg,.png" style="display:none" onchange="uploadPersonalTT(this)"/>
      </label>
      <div id="personal-tt" style="margin-top:8px;font-size:12px;color:var(--green)"></div>
    </div>
  </div>`;
  document.getElementById('main-content').innerHTML = html;
}

function getMyAttendance(){
  const allAtt = DB.get('attendance')||{};
  return allAtt[currentUser.id]||{total:60,present:42,subjects:{'DSA':{total:20,present:16},'ML':{total:20,present:14},'Math':{total:20,present:12}}};
}

function markAttendance(){
  openModal('Mark Attendance', `
    <div class="form-group"><label class="label">Subject</label>
      <select class="input" id="att-subject">
        ${Object.keys(getMyAttendance().subjects||{}).map(s=>`<option>${s}</option>`).join('')}
        <option>Other</option>
      </select>
    </div>
    <div class="form-group"><label class="label">Status</label>
      <div style="display:flex;gap:10px">
        <label style="flex:1;padding:12px;border:2px solid var(--gray-100);border-radius:10px;cursor:pointer;text-align:center;transition:all .15s" id="btn-present">
          <input type="radio" name="att-status" value="present" style="display:none" onclick="document.getElementById('btn-present').style.borderColor='var(--green)';document.getElementById('btn-absent').style.borderColor='var(--gray-100)'">
          âœ… Present
        </label>
        <label style="flex:1;padding:12px;border:2px solid var(--gray-100);border-radius:10px;cursor:pointer;text-align:center;transition:all .15s" id="btn-absent">
          <input type="radio" name="att-status" value="absent" style="display:none" onclick="document.getElementById('btn-absent').style.borderColor='var(--danger)';document.getElementById('btn-present').style.borderColor='var(--gray-100)'">
          âŒ Absent
        </label>
      </div>
    </div>
    <button class="btn btn-primary w-full" onclick="saveAttendance()">Save</button>
  `);
}

function saveAttendance(){
  const sub = document.getElementById('att-subject').value;
  const status = document.querySelector('[name=att-status]:checked')?.value;
  if(!status){showToast('Select Present or Absent','error');return}
  const allAtt = DB.get('attendance')||{};
  const myAtt = allAtt[currentUser.id]||getMyAttendance();
  if(!myAtt.subjects[sub]) myAtt.subjects[sub]={total:0,present:0};
  myAtt.subjects[sub].total++;
  myAtt.total++;
  if(status==='present'){myAtt.subjects[sub].present++;myAtt.present++;}
  allAtt[currentUser.id]=myAtt;
  DB.set('attendance',allAtt);
  closeModal();
  showToast('Attendance marked!');
  renderAttendance();
  checkAttendanceWarning(myAtt);
}

function checkAttendanceWarning(att){
  const pct = att.total?Math.round(att.present/att.total*100):0;
  if(pct<75){
    // Simulate email
    showToast('âš ï¸ Email alert sent â€” attendance below 75%!','error');
  }
}

function uploadPersonalTT(input){
  if(input.files[0]) document.getElementById('personal-tt').textContent = 'âœ… '+input.files[0].name+' uploaded!';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: TIMETABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimetable(){
  const tts = DB.get('timetables')||[];
  const html = `
  <div style="margin-bottom:16px;font-size:13px;color:var(--text-muted)">Official timetables uploaded by professors and administration.</div>
  ${tts.map(tt=>`
    <div class="file-item">
      <div class="file-icon" style="background:#e0f2fe">ğŸ“…</div>
      <div style="flex:1">
        <div class="fw-600">${tt.name}</div>
        <div style="font-size:11px;color:var(--text-muted)">${tt.type==='master'?'ğŸ› Master Timetable':'ğŸ“š Dept Timetable'}</div>
      </div>
      <span class="badge ${tt.type==='master'?'badge-red':'badge-blue'}">${tt.type==='master'?'Official':'Dept'}</span>
      <button class="btn btn-ghost btn-sm" onclick="fakeDownload('${tt.name}')">â¬‡ Download</button>
    </div>
  `).join('')}`;
  document.getElementById('main-content').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: DIRECTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDirectory(){
  const users = DB.get('users')||[];
  let html = `<div class="grid-2">`;
  users.forEach(u=>{
    const following = getFollowing()[u.id];
    html+=`<div class="card" style="cursor:pointer" onclick="openProfile('${u.id}')">
      <div class="card-body">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          <div style="width:48px;height:48px;border-radius:50%;background:${u.role==='admin'?'#fee2e2':'var(--green-pale)'};display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:${u.role==='admin'?'#b91c1c':'var(--green)'}">
            ${u.image?`<img src="${u.image}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"/>`:u.name[0]}
          </div>
          <div style="flex:1;min-width:0">
            <div class="fw-600 truncate">${u.name}</div>
            <div style="font-size:11px;color:var(--text-muted)">${u.designation}</div>
          </div>
          <span class="badge ${u.role==='admin'?'badge-red':'badge-green'}">${u.role}</span>
        </div>
        <div style="font-size:11px;color:var(--text-muted)">ğŸ“§ ${u.email}</div>
        <div style="font-size:11px;color:var(--text-muted)">ğŸ“ ${u.phone}</div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="event.stopPropagation();openProfile('${u.id}')">View Profile</button>
          ${currentUser.role==='student'?`<button class="btn btn-sm ${following?'btn-danger':'btn-primary'}" onclick="event.stopPropagation();toggleFollow('${u.id}',this)">${following?'Unfollow':'Follow'}</button>`:''}
        </div>
      </div>
    </div>`;
  });
  html+=`</div>`;
  document.getElementById('main-content').innerHTML = html;
}

function getFollowing(){return DB.get('following_'+currentUser.id)||{};}
function toggleFollow(uid, btn){
  const f = getFollowing();
  f[uid] = !f[uid];
  DB.set('following_'+currentUser.id, f);
  btn.textContent = f[uid]?'Unfollow':'Follow';
  btn.className = `btn btn-sm ${f[uid]?'btn-danger':'btn-primary'}`;
  showToast(f[uid]?'Following!':'Unfollowed');
}

function openProfile(uid){
  const u = (DB.get('users')||[]).find(u=>u.id===uid);
  if(!u) return;
  const notes = (DB.get('notes')||[]).filter(n=>n.uploaderId===uid);
  const qps = (DB.get('qpapers')||[]).filter(q=>q.uploaderId===uid);
  const anns = (DB.get('announcements')||[]).filter(a=>a.by===uid);
  const following = getFollowing()[uid];

  openModal(u.name, `
    <div class="profile-hero" style="border-radius:var(--radius);margin-bottom:16px">
      <div class="profile-avatar">${u.image?`<img src="${u.image}"/>`:(u.name||'?')[0]}</div>
      <div style="font-size:18px;font-weight:700;font-family:'DM Serif Display',serif">${u.name}</div>
      <div style="opacity:.8;font-size:12px">${u.designation} Â· ${u.dept}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;font-size:12px">
      <div style="background:var(--gray-50);padding:10px;border-radius:8px">ğŸ“§ ${u.email}</div>
      <div style="background:var(--gray-50);padding:10px;border-radius:8px">ğŸ“ ${u.phone}</div>
    </div>
    ${u.bio?`<div style="background:var(--green-pale);padding:12px;border-radius:8px;margin-bottom:12px;font-size:13px;color:var(--green-dim)">ğŸ“ ${u.bio}</div>`:''}
    ${currentUser.role==='student'?`<button class="btn ${following?'btn-danger':'btn-primary'} w-full btn-sm" style="margin-bottom:12px" onclick="toggleFollowModal('${uid}',this)">${following?'Unfollow':'Follow'}</button>`:''}
    ${u.timetableVisible?`<div style="background:var(--gray-50);padding:12px;border-radius:8px;margin-bottom:12px"><div class="fw-600" style="font-size:12px;margin-bottom:8px">ğŸ“… Timetable</div><button class="btn btn-ghost btn-sm" onclick="fakeDownload('Timetable_${u.name}.pdf')">View Timetable PDF</button></div>`:''}
    ${notes.length?`<div style="margin-bottom:12px"><div class="fw-600" style="font-size:12px;margin-bottom:8px">ğŸ“‚ Notes (${notes.length})</div>${notes.map(n=>`<div class="file-item"style="padding:8px 12px"><span>ğŸ“„</span><span style="flex:1;font-size:12px">${n.name}</span><button class="btn btn-ghost btn-sm" onclick="fakeDownload('${n.name}')">â¬‡</button></div>`).join('')}</div>`:''}
    ${qps.length?`<div><div class="fw-600" style="font-size:12px;margin-bottom:8px">ğŸ“„ Question Papers (${qps.length})</div>${qps.map(q=>`<div class="file-item"style="padding:8px 12px"><span>ğŸ“</span><span style="flex:1;font-size:12px">${q.name}</span><button class="btn btn-ghost btn-sm" onclick="fakeDownload('${q.name}')">â¬‡</button></div>`).join('')}</div>`:''}
  `);
}
function toggleFollowModal(uid, btn){
  const f = getFollowing();
  f[uid] = !f[uid];
  DB.set('following_'+currentUser.id, f);
  btn.textContent = f[uid]?'Unfollow':'Follow';
  btn.className = `btn ${f[uid]?'btn-danger':'btn-primary'} w-full btn-sm`;
  showToast(f[uid]?'Following!':'Unfollowed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: PROFILE (Prof/Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProfile(){
  const users = DB.get('users')||[];
  let me = users.find(u=>u.id===currentUser.id);
  if(!me){
    me = {id:currentUser.id,name:currentUser.name,role:currentUser.role,dept:'',designation:'',bio:'',email:'',phone:'',image:'',timetableVisible:true};
    users.push(me);
    DB.set('users',users);
  }
  document.getElementById('main-content').innerHTML = `
  <div class="card" style="max-width:600px">
    <div class="card-header"><span class="card-title">Edit Profile</span></div>
    <div class="card-body">
      <div style="text-align:center;margin-bottom:20px">
        <div id="prof-avatar-preview" style="width:80px;height:80px;border-radius:50%;background:var(--green);color:#fff;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;margin:0 auto 10px;overflow:hidden">
          ${me.image?`<img src="${me.image}" style="width:100%;height:100%;object-fit:cover"/>`:me.name[0]}
        </div>
        <label style="font-size:12px;color:var(--green);cursor:pointer;font-weight:600">ğŸ“· Upload Photo
          <input type="file" accept="image/*" style="display:none" onchange="uploadProfileImg(this)"/>
        </label>
      </div>
      <div class="form-group"><label class="label">Full Name</label><input class="input" id="p-name" value="${me.name}"/></div>
      <div class="form-group"><label class="label">Designation</label><input class="input" id="p-desig" value="${me.designation||''}"/></div>
      <div class="form-group"><label class="label">Department</label><input class="input" id="p-dept" value="${me.dept||''}"/></div>
      <div class="form-group"><label class="label">Email</label><input class="input" id="p-email" value="${me.email||''}"/></div>
      <div class="form-group"><label class="label">Phone</label><input class="input" id="p-phone" value="${me.phone||''}"/></div>
      <div class="form-group"><label class="label">Bio</label><textarea class="input" id="p-bio" rows="3" style="resize:vertical">${me.bio||''}</textarea></div>
      <div class="form-group"><label class="label">Tips Section</label><textarea class="input" id="p-tips" rows="3" placeholder="Share tips, advice, or resources with students..." style="resize:vertical">${me.tips||''}</textarea></div>
      <div class="form-group">
        <label class="label">Timetable Visibility</label>
        <div style="display:flex;align-items:center;gap:10px;margin-top:4px">
          <label class="toggle"><input type="checkbox" id="p-ttvis" ${me.timetableVisible?'checked':''}/><span class="toggle-slider"></span></label>
          <span style="font-size:13px;color:var(--text-muted)">Show timetable to students</span>
        </div>
      </div>
      <div class="form-group">
        <label class="label">Upload Timetable (PDF/Image)</label>
        <label style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:2px dashed var(--gray-200);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--text-muted)">
          ğŸ“ Choose File <input type="file" accept=".pdf,.jpg,.png" style="display:none" onchange="uploadTimetable(this)"/>
        </label>
        <div id="tt-upload-status" style="margin-top:6px;font-size:12px;color:var(--green)"></div>
      </div>
      <button class="btn btn-primary w-full" onclick="saveProfile()">ğŸ’¾ Save Profile</button>
    </div>
  </div>`;
}

function uploadProfileImg(input){
  if(!input.files[0]) return;
  const reader = new FileReader();
  reader.onload = e=>{
    document.getElementById('prof-avatar-preview').innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover"/>`;
    window._tempProfileImg = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
}

function uploadTimetable(input){
  if(input.files[0]) document.getElementById('tt-upload-status').textContent = 'âœ… '+input.files[0].name+' ready to save';
}

function saveProfile(){
  const users = DB.get('users')||[];
  let me = users.find(u=>u.id===currentUser.id);
  if(!me){me={id:currentUser.id,role:currentUser.role};users.push(me);}
  me.name = document.getElementById('p-name').value;
  me.designation = document.getElementById('p-desig').value;
  me.dept = document.getElementById('p-dept').value;
  me.email = document.getElementById('p-email').value;
  me.phone = document.getElementById('p-phone').value;
  me.bio = document.getElementById('p-bio').value;
  me.tips = document.getElementById('p-tips').value;
  me.timetableVisible = document.getElementById('p-ttvis').checked;
  if(window._tempProfileImg) me.image = window._tempProfileImg;
  DB.set('users',users);
  currentUser.name = me.name;
  localStorage.setItem('uup_session',JSON.stringify(currentUser));
  document.getElementById('sb-name').textContent = me.name;
  document.getElementById('sb-avatar').textContent = me.name[0];
  showToast('Profile saved!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MANAGE NOTES (Prof/Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderManageNotes(){
  const notes = (DB.get('notes')||[]).filter(n=>n.uploaderId===currentUser.id);
  document.getElementById('main-content').innerHTML = `
  <div class="card" style="margin-bottom:20px">
    <div class="card-header"><span class="card-title">Upload New Notes</span></div>
    <div class="card-body">
      <div class="grid-2">
        <div class="form-group"><label class="label">Note Name</label><input class="input" id="note-name" placeholder="e.g. Unit 3 â€” Trees.pdf"/></div>
        <div class="form-group"><label class="label">Subject</label><input class="input" id="note-subject" placeholder="e.g. DSA"/></div>
      </div>
      <div class="form-group">
        <label style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:2px dashed var(--gray-200);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--text-muted)">
          ğŸ“ Choose PDF/File <input type="file" accept=".pdf,.doc,.docx,.ppt,.pptx" style="display:none" id="note-file" onchange="document.getElementById('note-file-name').textContent=this.files[0]?.name||''"/>
        </label>
        <span id="note-file-name" style="margin-left:8px;font-size:12px;color:var(--green)"></span>
      </div>
      <button class="btn btn-primary" onclick="uploadNote()">â¬† Upload Note</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span class="card-title">My Uploaded Notes (${notes.length})</span></div>
    <div class="card-body" id="my-notes-list" style="padding:12px">
      ${notes.length?notes.map(n=>myFileItem(n)).join(''):`<div class="empty-state"><div class="empty-icon">ğŸ“‚</div>No notes uploaded yet.</div>`}
    </div>
  </div>`;
}

function myFileItem(n){
  return `<div class="file-item" id="fi-${n.id}">
    <div class="file-icon pdf">ğŸ“„</div>
    <div style="flex:1;min-width:0">
      <div class="fw-600 truncate" id="note-label-${n.id}">${n.name}</div>
      <div style="font-size:11px;color:var(--text-muted)">${n.subject} Â· ${n.date}</div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="renameNote('${n.id}')">âœï¸ Rename</button>
    <button class="btn btn-danger btn-sm" onclick="deleteNote('${n.id}')">ğŸ—‘</button>
  </div>`;
}

function uploadNote(){
  const name = document.getElementById('note-name').value.trim();
  const subj = document.getElementById('note-subject').value.trim();
  if(!name){showToast('Enter a note name','error');return}
  const notes = DB.get('notes')||[];
  notes.push({id:'n'+Date.now(),uploaderId:currentUser.id,name,subject:subj||'General',date:new Date().toISOString().split('T')[0],type:'pdf'});
  DB.set('notes',notes);
  showToast('Note uploaded!');
  renderManageNotes();
}
function renameNote(id){
  const notes = DB.get('notes')||[];
  const n = notes.find(x=>x.id===id);
  if(!n) return;
  const newName = prompt('Rename note:',n.name);
  if(newName&&newName.trim()){n.name=newName.trim();DB.set('notes',notes);renderManageNotes();showToast('Renamed!');}
}
function deleteNote(id){
  if(!confirm('Delete this note?')) return;
  DB.set('notes',(DB.get('notes')||[]).filter(n=>n.id!==id));
  document.getElementById('fi-'+id)?.remove();
  showToast('Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MANAGE QPAPERS (Prof/Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderManageQPapers(){
  const qps = (DB.get('qpapers')||[]).filter(q=>q.uploaderId===currentUser.id);
  document.getElementById('main-content').innerHTML = `
  <div class="card" style="margin-bottom:20px">
    <div class="card-header"><span class="card-title">Upload Question Paper</span></div>
    <div class="card-body">
      <div class="grid-2">
        <div class="form-group"><label class="label">Paper Name</label><input class="input" id="qp-name" placeholder="e.g. End-Sem 2025"/></div>
        <div class="form-group"><label class="label">Subject</label><input class="input" id="qp-subject" placeholder="e.g. DSA"/></div>
      </div>
      <div class="form-group"><label class="label">Year</label><input class="input" id="qp-year" placeholder="2025" style="max-width:200px"/></div>
      <div class="form-group"><label class="label">Important Questions (one per line)</label>
        <textarea class="input" id="qp-imp" rows="4" placeholder="Q1: Describe Quicksort&#10;Q3: Write BFS code" style="resize:vertical"></textarea>
      </div>
      <div class="form-group">
        <label style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:2px dashed var(--gray-200);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--text-muted)">
          ğŸ“ Choose PDF <input type="file" accept=".pdf" style="display:none" id="qp-file" onchange="document.getElementById('qp-fname').textContent=this.files[0]?.name||''"/>
        </label>
        <span id="qp-fname" style="margin-left:8px;font-size:12px;color:var(--green)"></span>
      </div>
      <button class="btn btn-primary" onclick="uploadQPaper()">â¬† Upload Paper</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><span class="card-title">My Question Papers (${qps.length})</span></div>
    <div class="card-body" id="qp-list" style="padding:12px">
      ${qps.length?qps.map(q=>`<div class="file-item" id="qfi-${q.id}">
        <div class="file-icon pdf">ğŸ“</div>
        <div style="flex:1"><div class="fw-600">${q.name}</div><div style="font-size:11px;color:var(--text-muted)">${q.subject} Â· ${q.year} Â· ${q.important?.length||0} imp. questions</div></div>
        <button class="btn btn-danger btn-sm" onclick="deleteQP('${q.id}')">ğŸ—‘</button>
      </div>`).join(''):`<div class="empty-state"><div class="empty-icon">ğŸ“„</div>No question papers yet.</div>`}
    </div>
  </div>`;
}
function uploadQPaper(){
  const name = document.getElementById('qp-name').value.trim();
  const subj = document.getElementById('qp-subject').value.trim();
  const year = document.getElementById('qp-year').value.trim();
  const imp = document.getElementById('qp-imp').value.trim().split('\n').filter(Boolean);
  if(!name){showToast('Enter paper name','error');return}
  const qps = DB.get('qpapers')||[];
  qps.push({id:'q'+Date.now(),uploaderId:currentUser.id,name,subject:subj||'General',year:year||new Date().getFullYear(),important:imp});
  DB.set('qpapers',qps);
  showToast('Question paper uploaded!');
  renderManageQPapers();
}
function deleteQP(id){
  if(!confirm('Delete?'))return;
  DB.set('qpapers',(DB.get('qpapers')||[]).filter(q=>q.id!==id));
  document.getElementById('qfi-'+id)?.remove();
  showToast('Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MANAGE ANNOUNCEMENTS (Prof/Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderManageAnnouncements(){
  const isAdmin = currentUser.role==='admin';
  const anns = isAdmin?(DB.get('announcements')||[]):(DB.get('announcements')||[]).filter(a=>a.by===currentUser.id);
  document.getElementById('main-content').innerHTML = `
  <div class="card" style="margin-bottom:20px">
    <div class="card-header"><span class="card-title">Post New Announcement</span></div>
    <div class="card-body">
      <div class="form-group"><label class="label">Type</label>
        <select class="input" id="ann-type">
          <option value="class">ğŸ“š Class Announcement</option>
          ${isAdmin?`<option value="university">ğŸ› University-wide</option>`:''}
        </select>
      </div>
      <div class="form-group"><label class="label">Department / Target</label>
        <input class="input" id="ann-dept" placeholder="e.g. Computer Science / All"/>
      </div>
      <div class="form-group"><label class="label">Message</label>
        <textarea class="input" id="ann-text" rows="4" placeholder="Write your announcement..." style="resize:vertical"></textarea>
      </div>
      <button class="btn btn-primary" onclick="postAnnouncement()">ğŸ“¢ Post Announcement</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><span class="card-title">${isAdmin?'All Announcements':'My Announcements'} (${anns.length})</span></div>
    <div class="card-body" id="ann-manage-list" style="padding:12px">
      ${anns.length?anns.slice().reverse().map(a=>annManageItem(a,isAdmin)).join(''):`<div class="empty-state"><div class="empty-icon">ğŸ“¢</div>No announcements yet.</div>`}
    </div>
  </div>`;
}
function annManageItem(a, isAdmin){
  return `<div class="announcement-item" id="ann-${a.id}">
    <div class="flex justify-between">
      <span class="ann-type-badge ${a.type==='university'?'badge-red':'badge-blue'}">${a.type==='university'?'ğŸ› University':'ğŸ“š Class'}</span>
      <span style="font-size:11px;color:var(--text-muted)">${a.date}</span>
    </div>
    <div style="font-size:13px;margin-top:6px">${a.text}</div>
    <div class="flex justify-between items-center" style="margin-top:8px">
      <span style="font-size:11px;color:var(--text-muted)">â€” ${a.byName} Â· ${a.dept}</span>
      ${(isAdmin||a.by===currentUser.id)?`<button class="btn btn-danger btn-sm" onclick="deleteAnn('${a.id}')">ğŸ—‘ Delete</button>`:''}
    </div>
  </div>`;
}
function postAnnouncement(){
  const type = document.getElementById('ann-type').value;
  const dept = document.getElementById('ann-dept').value||'General';
  const text = document.getElementById('ann-text').value.trim();
  if(!text){showToast('Write something first','error');return}
  const me = (DB.get('users')||[]).find(u=>u.id===currentUser.id)||{name:currentUser.name};
  const anns = DB.get('announcements')||[];
  anns.push({id:'a'+Date.now(),by:currentUser.id,byName:me.name||currentUser.name,role:currentUser.role,type,text,dept,date:new Date().toISOString().split('T')[0]});
  DB.set('announcements',anns);
  showToast('Announcement posted!');
  renderManageAnnouncements();
  buildSidebar();
}
function deleteAnn(id){
  if(!confirm('Delete this announcement?'))return;
  DB.set('announcements',(DB.get('announcements')||[]).filter(a=>a.id!==id));
  document.getElementById('ann-'+id)?.remove();
  showToast('Deleted');
  buildSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: MASTER ATTENDANCE (Admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMasterAttendance(){
  const master = DB.get('masterAttendance')||[];
  document.getElementById('main-content').innerHTML = `
  <div class="card" style="margin-bottom:20px">
    <div class="card-header"><span class="card-title">Upload Master Attendance (.xlsx)</span></div>
    <div class="card-body">
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Upload an Excel file with columns: <strong>StudentID, Name, TotalClasses, AttendedClasses</strong></p>
      <label style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:2px dashed var(--green);border-radius:var(--radius);cursor:pointer;font-size:13px;color:var(--green)">
        ğŸ“Š Choose .xlsx File <input type="file" accept=".xlsx,.csv" style="display:none" onchange="parseMasterAttendance(this)"/>
      </label>
      <div id="master-upload-status" style="margin-top:12px"></div>
      <button class="btn btn-ghost btn-sm mt-3" onclick="loadSampleMasterAttendance()">Load Sample Data</button>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><span class="card-title">Current Master Attendance (${master.length} students)</span></div>
    <div id="master-table" style="overflow-x:auto">
      ${master.length?renderMasterTable(master):`<div class="empty-state"><div class="empty-icon">ğŸ“Š</div>No master attendance uploaded yet.</div>`}
    </div>
  </div>`;
}

function renderMasterTable(data){
  return `<table style="width:100%;border-collapse:collapse">
    <thead><tr style="background:var(--gray-50)">
      ${['Student ID','Name','Attended','Total','%','Status'].map(h=>`<th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px">${h}</th>`).join('')}
    </tr></thead>
    <tbody>${data.map(row=>{
      const pct=row.total?Math.round(row.attended/row.total*100):0;
      const ok=pct>=75;
      return `<tr style="border-top:1px solid var(--gray-100)">
        <td style="padding:10px 16px;font-size:13px;font-weight:600">${row.id}</td>
        <td style="padding:10px 16px;font-size:13px">${row.name}</td>
        <td style="padding:10px 16px;font-size:13px">${row.attended}</td>
        <td style="padding:10px 16px;font-size:13px">${row.total}</td>
        <td style="padding:10px 16px"><span style="font-weight:700;color:${ok?'var(--green)':'var(--danger)'}">${pct}%</span></td>
        <td style="padding:10px 16px"><span class="badge ${ok?'badge-green':'badge-red'}">${ok?'âœ… OK':'âš ï¸ Low'}</span></td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

function loadSampleMasterAttendance(){
  const sample = [
    {id:'STU2024001',name:'Ananya Verma',attended:42,total:60},
    {id:'STU2024002',name:'Rohan Kapoor',attended:55,total:60},
    {id:'STU2024003',name:'Priya Singh',attended:38,total:60},
    {id:'STU2024004',name:'Aryan Sharma',attended:48,total:60},
    {id:'STU2024005',name:'Meera Nair',attended:30,total:60},
    {id:'STU2024006',name:'Vikram Joshi',attended:52,total:60},
  ];
  DB.set('masterAttendance',sample);
  showToast('Sample data loaded!');
  renderMasterAttendance();
}

function parseMasterAttendance(input){
  if(!input.files[0]){return}
  // Since we can't actually parse xlsx without a library in pure HTML, show simulation
  document.getElementById('master-upload-status').innerHTML = `<div class="badge badge-green">âœ… ${input.files[0].name} uploaded. Processing...</div>`;
  setTimeout(()=>{loadSampleMasterAttendance();},800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function globalSearch(q){
  const res = document.getElementById('search-results');
  if(!q||q.length<2){res.classList.add('hidden');return}
  const users = DB.get('users')||[];
  const matches = users.filter(u=>u.name.toLowerCase().includes(q.toLowerCase())||u.designation?.toLowerCase().includes(q.toLowerCase()));
  if(!matches.length){res.innerHTML='<div style="padding:12px 14px;font-size:13px;color:var(--text-muted)">No results found</div>';res.classList.remove('hidden');return}
  res.innerHTML = matches.map(u=>`
    <div class="search-result-item" onclick="selectSearchResult('${u.id}')">
      <div style="width:32px;height:32px;border-radius:50%;background:var(--green-pale);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green);flex-shrink:0">${u.name[0]}</div>
      <div><div style="font-size:13px;font-weight:600">${u.name}</div><div style="font-size:11px;color:var(--text-muted)">${u.designation||u.role}</div></div>
    </div>`).join('');
  res.classList.remove('hidden');
}
function selectSearchResult(uid){
  document.getElementById('global-search').value='';
  document.getElementById('search-results').classList.add('hidden');
  openProfile(uid);
}
document.addEventListener('click',e=>{
  if(!e.target.closest('#global-search-wrap')) document.getElementById('search-results').classList.add('hidden');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(title, body){
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = body;
  document.getElementById('modal-overlay').classList.remove('hidden');
}
function closeModal(){document.getElementById('modal-overlay').classList.add('hidden');}
function closeModalOverlay(e){if(e.target===document.getElementById('modal-overlay'))closeModal();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg, type='success'){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast'+(type==='error'?' error':'');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.add('hidden'),3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fakeDownload(name){
  showToast('â¬‡ Downloading: '+name);
  // In real implementation, this triggers actual file download
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  initDB();
  const session = localStorage.getItem('uup_session');
  if(session){
    try{currentUser=JSON.parse(session);bootApp();}
    catch{localStorage.removeItem('uup_session');}
  }
});
</script>
</body>
</html>
