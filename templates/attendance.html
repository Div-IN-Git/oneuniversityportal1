{% extends 'base.html' %}
{% block app_content %}
{% if mode == 'student' %}
<section class="card">
  <div class="attendance-overview">
    <div class="ring" style="--val: {{ overall.percent }}">
      <strong>{{ overall.percent }}%</strong>
    </div>
    <div>
      <h3>Overall: {{ overall.present }} / {{ overall.total }} classes</h3>
      {% if overall.percent < attendance_threshold %}
      <p class="text-danger">You need regular attendance to reach {{ attendance_threshold }}%.</p>
      {% else %}
      <p class="text-ok">Good progress. Keep consistency till semester end.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h3>Mark Your Attendance</h3>
  <form class="form" method="post">
    <label>Subject</label>
    <select name="subject" id="student-subject" required>
      {% if subject_options %}
        {% for subject in subject_options %}
        <option value="{{ subject }}">{{ subject }}</option>
        {% endfor %}
      {% endif %}
      <option value="__custom__">Other (type manually)</option>
    </select>

    <label>Custom Subject (only if "Other" selected)</label>
    <input type="text" name="custom_subject" id="custom-student-subject" placeholder="e.g. Operating Systems" />

    <label>Status</label>
    <select name="status" required>
      <option value="present">Present</option>
      <option value="absent">Absent</option>
    </select>

    <label>Date</label>
    <input type="date" name="class_date" />

    <button class="btn" type="submit">Save My Attendance</button>
  </form>
</section>

<section class="card">
  <h3>Subject-wise Attendance</h3>
  {% if rows %}
    {% for item in rows %}
    <div class="att-row">
      <div class="between">
        <strong>{{ item.subject }}</strong>
        <span class="{% if item.is_shortage %}text-danger{% endif %}">{{ item.percent }}% ({{ item.present }}/{{ item.total }})</span>
      </div>
      <div class="progress"><span style="width: {{ item.percent }}%"></span></div>
    </div>
    {% endfor %}
  {% else %}
    <p class="muted">No attendance records yet.</p>
  {% endif %}
</section>
{% else %}
<section class="grid-2">
  <article class="card">
    <h3>Select Student</h3>
    <form class="form" method="get">
      <select name="student_id" required>
        {% for student in students %}
        <option value="{{ student.id }}" {% if selected_student and selected_student.id == student.id %}selected{% endif %}>
          {{ student.name }} ({{ student.university_id }})
        </option>
        {% endfor %}
      </select>
      <button class="btn btn-light" type="submit">Load</button>
    </form>

    {% if selected_student %}
    <hr />
    <p><strong>{{ selected_student.name }}</strong></p>
    <p class="meta">{{ selected_student.email }} | {{ selected_student.branch }}</p>
    <p class="meta">Overall attendance: {{ overall.percent }}%</p>
    <form method="post" action="{{ url_for('send_attendance_alert', student_id=selected_student.id) }}">
      <button class="btn" type="submit">Send Shortage Email</button>
    </form>
    {% endif %}
  </article>

  <article class="card">
    <h3>Mark Attendance</h3>
    <form class="form" method="post">
      <label>Student</label>
      <select name="student_id" required>
        {% for student in students %}
        <option value="{{ student.id }}" {% if selected_student and selected_student.id == student.id %}selected{% endif %}>
          {{ student.name }}
        </option>
        {% endfor %}
      </select>

      <label>Subject</label>
      <input list="attendance-subjects" type="text" name="subject" placeholder="DSA" required />

      <label>Status</label>
      <select name="status" required>
        <option value="present">Present</option>
        <option value="absent">Absent</option>
      </select>

      <label>Class Date</label>
      <input type="date" name="class_date" />

      <label class="check-row">
        <input type="checkbox" name="send_email" />
        If shortage occurs, send email alert
      </label>

      <label class="check-row">
        <input type="checkbox" name="publish_to_student" />
        Publish this attendance to student view
      </label>

      <button class="btn" type="submit">Save Attendance</button>
    </form>
  </article>
</section>

<section class="card">
  <h3>Subject-wise Attendance</h3>
  {% if rows %}
    {% for item in rows %}
    <div class="att-row">
      <div class="between">
        <strong>{{ item.subject }}</strong>
        <span class="{% if item.is_shortage %}text-danger{% endif %}">{{ item.percent }}% ({{ item.present }}/{{ item.total }})</span>
      </div>
      <div class="progress"><span style="width: {{ item.percent }}%"></span></div>
    </div>
    {% endfor %}
  {% else %}
    <p class="muted">No attendance records for this student yet.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Teacher Marked Entries</h3>
  {% if teacher_entries %}
    {% for entry in teacher_entries %}
    <div class="list-card between">
      <div>
        <h4>{{ entry.subject }} - {{ entry.class_date }}</h4>
        <p class="meta">Status: {{ entry.status|capitalize }} | Marked by {{ entry.marker_name }}</p>
        <p class="meta">Student visibility: {% if entry.is_published %}Published{% else %}Hidden{% endif %}</p>
      </div>
      {% if current_user.role == 'admin' or entry.marked_by == current_user.id %}
      <form method="post" action="{{ url_for('toggle_attendance_publish', entry_id=entry.id) }}">
        <input type="hidden" name="publish" value="{% if entry.is_published %}0{% else %}1{% endif %}" />
        <button class="btn btn-light" type="submit">
          {% if entry.is_published %}Hide{% else %}Publish{% endif %}
        </button>
      </form>
      {% endif %}
    </div>
    {% endfor %}
  {% else %}
    <p class="muted">No teacher entries yet.</p>
  {% endif %}
</section>
{% endif %}

{% if mode != 'student' %}
<datalist id="attendance-subjects">
  {% if subject_options %}
    {% for subject in subject_options %}
    <option value="{{ subject }}"></option>
    {% endfor %}
  {% endif %}
</datalist>
{% endif %}

{% if mode == 'student' %}
<script>
  (function () {
    const subjectSelect = document.getElementById('student-subject');
    const customInput = document.getElementById('custom-student-subject');
    if (!subjectSelect || !customInput) return;
    const syncCustom = () => {
      customInput.required = subjectSelect.value === '__custom__';
      if (!customInput.required) customInput.value = '';
    };
    subjectSelect.addEventListener('change', syncCustom);
    syncCustom();
  })();
</script>
{% endif %}
{% endblock %}
