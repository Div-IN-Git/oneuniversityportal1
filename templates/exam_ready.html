{% extends 'base.html' %}
{% block app_content %}
<section class="grid-2">
  <article class="card">
    <h3>Generate Exam-Ready Questions</h3>
    <form class="form" method="post">
      <label>Source Type</label>
      <select name="source_type" id="source_type">
        <option value="syllabus">Syllabus Text</option>
        <option value="note">From Uploaded Note</option>
      </select>
      <div id="note_picker" class="hidden">
        <label>Select Note</label>
        <select name="note_id">
          {% for note in notes %}
          <option value="{{ note.id }}">{{ note.title }} ({{ note.subject }} | {{ note.professor_name }})</option>
          {% endfor %}
        </select>
      </div>
      <div id="syllabus_box">
        <label>Syllabus / Topic Content</label>
        <textarea name="syllabus_text" rows="10" placeholder="Paste syllabus modules, key formulas, concepts..."></textarea>
      </div>
      <button class="btn" type="submit">Generate Questions</button>
    </form>
  </article>

  <article class="card">
    <h3>Generated Questions</h3>
    {% if generated_questions %}
    <ol>{% for q in generated_questions %}<li style="margin-bottom:.5rem">{{ q }}</li>{% endfor %}</ol>
    {% else %}
    <p class="muted">No generated questions yet.</p>
    {% endif %}
  </article>
</section>

<!-- ‚îÄ‚îÄ AI PDF Summary ‚îÄ‚îÄ -->
<section class="card" style="margin-top:1rem">
  <h3>AI PDF Summary</h3>
  <p class="muted">Upload any size PDF ‚Äî it will be automatically split into chunks and processed one by one.</p>

  {% if not summarizer_ready %}
  <p style="color:var(--danger);font-weight:600">‚ö† {{ summarizer_error }}</p>
  {% endif %}

  <form class="form" id="pdf_form" style="max-width:520px">
    <label>Upload PDF</label>
    <input type="file" id="pdf_input" accept=".pdf" {% if not summarizer_ready %}disabled{% endif %} />
    <p id="file_hint" style="margin:0;font-size:.85rem;color:#6d8578"></p>
    <button class="btn" type="submit" id="pdf_btn" {% if not summarizer_ready %}disabled{% endif %}>Generate Summary</button>
  </form>

  <!-- Progress -->
  <div id="progress_area" style="display:none;margin-top:1rem">
    <div id="status_log" style="
      background:#f0f7f3;border:1px solid #c8dfd2;border-radius:10px;
      padding:.75rem;font-size:.88rem;color:#2b4a3b;min-height:3rem;margin-bottom:.75rem;
      max-height:180px;overflow-y:auto
    "></div>

    <div id="bar_wrap" style="display:none;margin-bottom:.75rem">
      <div style="display:flex;justify-content:space-between;margin-bottom:.25rem">
        <span id="bar_label" style="font-size:.85rem;color:var(--muted)">Uploading‚Ä¶</span>
        <span id="bar_pct" style="font-size:.85rem;font-weight:700;color:var(--primary-deep)">0%</span>
      </div>
      <div class="progress"><span id="bar" style="width:0%;background:var(--primary);transition:width .35s ease;display:block;height:100%;border-radius:inherit"></span></div>
    </div>
  </div>

  <!-- Result -->
  <div id="result_area" style="display:none;margin-top:1rem">
    <hr/>
    <h4>üìã Final Summary</h4>
    <div id="summary_out" style="
      background:#f8fdfb;border:1px solid #c8dfd2;border-radius:10px;
      padding:.9rem;white-space:pre-wrap;font-size:.93rem;line-height:1.6
    "></div>
    <div id="q_wrap" style="display:none;margin-top:1rem">
      <h4>üìù Exam Questions</h4>
      <ol id="q_list" style="padding-left:1.2rem;line-height:1.9"></ol>
    </div>
    <button class="btn btn-light" id="reset_btn" style="margin-top:.75rem" type="button">Upload Another PDF</button>
  </div>
</section>

<script>
(function(){
  const CHUNK_SIZE = 3.5 * 1024 * 1024; // 3.5 MB per chunk (safe under Vercel 4.5 MB limit)

  const form       = document.getElementById('pdf_form');
  const fileInput  = document.getElementById('pdf_input');
  const fileHint   = document.getElementById('file_hint');
  const btn        = document.getElementById('pdf_btn');
  const progArea   = document.getElementById('progress_area');
  const statusLog  = document.getElementById('status_log');
  const barWrap    = document.getElementById('bar_wrap');
  const bar        = document.getElementById('bar');
  const barPct     = document.getElementById('bar_pct');
  const barLabel   = document.getElementById('bar_label');
  const resultArea = document.getElementById('result_area');
  const summaryOut = document.getElementById('summary_out');
  const qWrap      = document.getElementById('q_wrap');
  const qList      = document.getElementById('q_list');
  const resetBtn   = document.getElementById('reset_btn');

  // Source type toggle
  const sourceType  = document.getElementById('source_type');
  const notePicker  = document.getElementById('note_picker');
  const syllabusBox = document.getElementById('syllabus_box');
  function toggleSource(){
    if(!sourceType) return;
    notePicker.classList.toggle('hidden', sourceType.value !== 'note');
    syllabusBox.classList.toggle('hidden', sourceType.value === 'note');
  }
  sourceType && sourceType.addEventListener('change', toggleSource);
  toggleSource();

  // File hint
  fileInput.addEventListener('change', function(){
    const f = this.files[0];
    if(!f){ fileHint.textContent=''; return; }
    const mb = (f.size/1024/1024).toFixed(1);
    const chunks = Math.ceil(f.size / CHUNK_SIZE);
    fileHint.textContent = f.name + ' ¬∑ ' + mb + ' MB' + (chunks > 1 ? ' ¬∑ will be split into ' + chunks + ' chunks' : '');
  });

  // Reset
  resetBtn.addEventListener('click', function(){
    form.reset();
    fileHint.textContent      = '';
    progArea.style.display    = 'none';
    resultArea.style.display  = 'none';
    barWrap.style.display     = 'none';
    statusLog.innerHTML       = '';
    summaryOut.textContent    = '';
    qList.innerHTML           = '';
    qWrap.style.display       = 'none';
    bar.style.width           = '0%';
    barPct.textContent        = '0%';
    btn.disabled              = false;
    btn.textContent           = 'Generate Summary';
  });

  // Main submit
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const file = fileInput.files[0];
    if(!file){ alert('Please select a PDF file.'); return; }

    btn.disabled           = true;
    btn.textContent        = 'Processing‚Ä¶';
    progArea.style.display = 'block';
    resultArea.style.display = 'none';
    statusLog.innerHTML    = '';

    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
    log('üìÑ ' + file.name + ' (' + (file.size/1024/1024).toFixed(1) + ' MB) ‚Üí ' + totalChunks + ' chunk(s)');

    if(totalChunks > 1){
      barWrap.style.display = 'block';
      setBar(0, totalChunks);
    }

    const chunkSummaries = [];

    for(let i = 0; i < totalChunks; i++){
      const start = i * CHUNK_SIZE;
      const end   = Math.min(start + CHUNK_SIZE, file.size);
      const blob  = file.slice(start, end);

      // Wrap raw bytes in a minimal valid PDF shell so server can parse it
      // Actually we send raw bytes ‚Äî server uses pypdf which handles partial streams
      // Better: send as a named file with chunk metadata in form fields
      const fd = new FormData();
      fd.append('summary_pdf', blob, file.name);  // keep original filename
      fd.append('chunk_index', i);
      fd.append('total_chunks', totalChunks);
      fd.append('original_filename', file.name);

      log('‚¨Ü Uploading chunk ' + (i+1) + '/' + totalChunks + ' (' + ((blob.size)/1024).toFixed(0) + ' KB)‚Ä¶');

      let resp;
      try {
        resp = await fetch('/exam-ready/chunk-upload', { method: 'POST', body: fd });
      } catch(err){
        log('‚ùå Network error on chunk ' + (i+1) + ': ' + err.message, 'var(--danger)');
        btn.disabled = false; btn.textContent = 'Generate Summary'; return;
      }

      if(!resp.ok){
        const txt = await resp.text();
        log('‚ùå Server error on chunk ' + (i+1) + ': ' + resp.status + ' ‚Äî ' + txt.substring(0,120), 'var(--danger)');
        btn.disabled = false; btn.textContent = 'Generate Summary'; return;
      }

      const data = await resp.json();
      if(data.error){
        log('‚ùå ' + data.error, 'var(--danger)');
        btn.disabled = false; btn.textContent = 'Generate Summary'; return;
      }

      log('‚úÖ Chunk ' + (i+1) + ' summarised.');
      if(data.chunk_summary) chunkSummaries.push(data.chunk_summary);
      setBar(i+1, totalChunks);
    }

    // All chunks done ‚Äî ask server to merge + generate questions
    log('‚ú® All chunks done. Merging and generating exam questions‚Ä¶');

    let mergeResp;
    try {
      mergeResp = await fetch('/exam-ready/merge-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ summaries: chunkSummaries })
      });
    } catch(err){
      log('‚ùå Merge error: ' + err.message, 'var(--danger)');
      btn.disabled = false; btn.textContent = 'Generate Summary'; return;
    }

    const mergeData = await mergeResp.json();
    if(mergeData.error){
      log('‚ùå ' + mergeData.error, 'var(--danger)');
      btn.disabled = false; btn.textContent = 'Generate Summary'; return;
    }

    // Show results
    summaryOut.textContent   = mergeData.summary || '(No summary returned)';
    resultArea.style.display = 'block';
    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    if(mergeData.questions && mergeData.questions.length){
      qList.innerHTML = mergeData.questions
        .map(function(q){ return '<li style="margin-bottom:.4rem">' + q + '</li>'; })
        .join('');
      qWrap.style.display = 'block';
    }

    log('‚úÖ Done!', 'var(--primary-deep)');
    btn.disabled    = false;
    btn.textContent = 'Generate Summary';
  });

  function setBar(done, total){
    const pct = Math.round((done/total)*100);
    bar.style.width    = pct + '%';
    barPct.textContent = pct + '%';
    barLabel.textContent = 'Chunk ' + done + ' of ' + total + ' uploaded';
  }

  function log(msg, color){
    const p = document.createElement('p');
    p.style.margin = '.15rem 0';
    if(color) p.style.color = color;
    p.textContent = msg;
    statusLog.appendChild(p);
    statusLog.scrollTop = statusLog.scrollHeight;
  }
})();
</script>
{% endblock %}
